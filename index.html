<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Testbericht-Felder (Airtable Sync mit Sprachsteuerung)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { font-weight: bold; display: block; margin-top: 12px; }
    input, textarea, select { width: 100%; padding: 6px; margin-top: 4px; }
    .active-field { background-color: #e6ffed; border: 2px solid #38a169; }
    #statusMessage { margin-top: 10px; }
    button { padding: 6px 12px; }
    #speechBtn.active { background-color: #38a169; color: white; }
  </style>
</head>
<body>
  <h2>Testbericht-Felder (Airtable Sync mit Sprachsteuerung)</h2>

  <button id="speechBtn">üéô Spracheingabe starten</button>
  <div id="statusMessage"></div>

  <form id="airtableForm">
    <label for="fldgfegUsXpOxuVnT">Report</label>
    <input type="text" id="fldgfegUsXpOxuVnT">

    <label for="fldIo9EAPIMXYGYxs">Project</label>
    <input type="text" id="fldIo9EAPIMXYGYxs">

    <label for="fldQAV4RIP33nxH0y">Test</label>
    <input type="text" id="fldQAV4RIP33nxH0y">

    <label for="fldmHouwqjRyZw1z1">DVP</label>
    <input type="text" id="fldmHouwqjRyZw1z1">

    <label for="fldZ56NkIyj8kSO3E">Test samples</label>
    <input type="text" id="fldZ56NkIyj8kSO3E">

    <br><br>
    <button type="submit">An Airtable senden</button>
    <div id="status"></div>
  </form>

  <script>
    let currentField = null;
    const statusMessage = document.getElementById("statusMessage");

    const fieldMap = {
      "report": "fldgfegUsXpOxuVnT",
      "projekt": "fldIo9EAPIMXYGYxs",
      "project": "fldIo9EAPIMXYGYxs",
      "test": "fldQAV4RIP33nxH0y",
      "dvp": "fldmHouwqjRyZw1z1",
      "test samples": "fldZ56NkIyj8kSO3E"
    };

    function setActiveField(name) {
      if (currentField) currentField.classList.remove("active-field");
      const fieldId = fieldMap[name.toLowerCase()];
      if (!fieldId) return false;
      const el = document.getElementById(fieldId);
      if (el) {
        el.focus();
        el.classList.add("active-field");
        currentField = el;
        return true;
      }
      return false;
    }

    async function sendAudioToAPI(audioBlob) {
      const formData = new FormData();
      formData.append("audio", audioBlob, "speech.wav");
      const res = await fetch("/api/speech", { method: "POST", body: formData });
      const data = await res.json();
      return data.text;
    }

    async function startRecording() {
      const btn = document.getElementById("speechBtn");
      btn.textContent = "üî¥ Spracheingabe stoppen";
      btn.classList.add("active");
      statusMessage.innerHTML = "üé§ Aufnahme l√§uft...";

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      const chunks = [];

      mediaRecorder.ondataavailable = e => chunks.push(e.data);

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(chunks, { type: 'audio/wav' });
        const text = await sendAudioToAPI(audioBlob);
        statusMessage.innerHTML = `‚úÖ Erkannt: ${text}`;

        const wasSet = setActiveField(text);
        if (!wasSet && currentField) {
          currentField.value += (currentField.value ? " " : "") + text;
        }

        stream.getTracks().forEach(track => track.stop());
        btn.textContent = "üéô Spracheingabe starten";
        btn.classList.remove("active");
      };

      btn.onclick = () => {
        mediaRecorder.stop();
        btn.onclick = startRecording;
      };

      mediaRecorder.start();
    }

    document.getElementById("speechBtn").onclick = startRecording;

    document.getElementById("airtableForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fields = {};
      document.querySelectorAll("input, textarea, select").forEach(input => {
        if (input.value) fields[input.id] = input.value;
      });

      const payload = {
        records: [{ id: "reck6u6zEVw3zhYoi", fields }],
        typecast: true
      };

      const res = await fetch("https://api.airtable.com/v0/appzwNxopAPU5CEG7/tblsRZ7ocjdhRp48T", {
        method: "PATCH",
        headers: {
          Authorization: "Bearer patWnOn1yz2o0UIDX.ddf441ba81728498f83988a569566b17048c1571f3f9de1bfad217f649122a79",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      document.getElementById("status").textContent = res.ok ? "‚úÖ Erfolgreich an Airtable gesendet!" : `‚ùå Fehler: ${JSON.stringify(result)}`;
    });
  </script>
</body>
</html>
